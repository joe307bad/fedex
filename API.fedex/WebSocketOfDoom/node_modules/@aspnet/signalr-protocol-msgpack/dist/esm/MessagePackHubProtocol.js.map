{"version":3,"file":"MessagePackHubProtocol.js","sourceRoot":"","sources":["../../src/MessagePackHubProtocol.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) .NET Foundation. All rights reserved.\r\n// Licensed under the Apache License, Version 2.0. See License.txt in the project root for license information.\r\n\r\nimport { Buffer } from \"buffer\";\r\nimport * as msgpack5 from \"msgpack5\";\r\n\r\nimport { CompletionMessage, HubMessage, IHubProtocol, ILogger, InvocationMessage, LogLevel, MessageHeaders, MessageType, NullLogger, StreamInvocationMessage, StreamItemMessage, TransferFormat } from \"@aspnet/signalr\";\r\n\r\nimport { BinaryMessageFormat } from \"./BinaryMessageFormat\";\r\n\r\nexport class MessagePackHubProtocol implements IHubProtocol {\r\n\r\n    public readonly name: string = \"messagepack\";\r\n    public readonly version: number = 1;\r\n\r\n    public readonly transferFormat: TransferFormat = TransferFormat.Binary;\r\n\r\n    public parseMessages(input: ArrayBuffer, logger: ILogger): HubMessage[] {\r\n        if (logger === null) {\r\n            logger = NullLogger.instance;\r\n        }\r\n        return BinaryMessageFormat.parse(input).map((m) => this.parseMessage(m, logger));\r\n    }\r\n\r\n    private parseMessage(input: Uint8Array, logger: ILogger): HubMessage {\r\n        if (input.length === 0) {\r\n            throw new Error(\"Invalid payload.\");\r\n        }\r\n\r\n        const msgpack = msgpack5();\r\n        const properties = msgpack.decode(new Buffer(input));\r\n        if (properties.length === 0 || !(properties instanceof Array)) {\r\n            throw new Error(\"Invalid payload.\");\r\n        }\r\n\r\n        const messageType = properties[0] as MessageType;\r\n\r\n        switch (messageType) {\r\n            case MessageType.Invocation:\r\n                return this.createInvocationMessage(this.readHeaders(properties), properties);\r\n            case MessageType.StreamItem:\r\n                return this.createStreamItemMessage(this.readHeaders(properties), properties);\r\n            case MessageType.Completion:\r\n                return this.createCompletionMessage(this.readHeaders(properties), properties);\r\n            case MessageType.Ping:\r\n                return this.createPingMessage(properties);\r\n            case MessageType.Close:\r\n                return this.createCloseMessage(properties);\r\n            default:\r\n                // Future protocol changes can add message types, old clients can ignore them\r\n                logger.log(LogLevel.Information, \"Unknown message type '\" + messageType + \"' ignored.\");\r\n                return null;\r\n        }\r\n    }\r\n\r\n    private createCloseMessage(properties: any[]): HubMessage {\r\n        // check minimum length to allow protocol to add items to the end of objects in future releases\r\n        if (properties.length < 2) {\r\n            throw new Error(\"Invalid payload for Close message.\");\r\n        }\r\n\r\n        return {\r\n            // Close messages have no headers.\r\n            error: properties[1],\r\n            type: MessageType.Close,\r\n        } as HubMessage;\r\n    }\r\n\r\n    private createPingMessage(properties: any[]): HubMessage {\r\n        // check minimum length to allow protocol to add items to the end of objects in future releases\r\n        if (properties.length < 1) {\r\n            throw new Error(\"Invalid payload for Ping message.\");\r\n        }\r\n\r\n        return {\r\n            // Ping messages have no headers.\r\n            type: MessageType.Ping,\r\n        } as HubMessage;\r\n    }\r\n\r\n    private createInvocationMessage(headers: MessageHeaders, properties: any[]): InvocationMessage {\r\n        // check minimum length to allow protocol to add items to the end of objects in future releases\r\n        if (properties.length < 5) {\r\n            throw new Error(\"Invalid payload for Invocation message.\");\r\n        }\r\n\r\n        const invocationId = properties[2] as string;\r\n        if (invocationId) {\r\n            return {\r\n                arguments: properties[4],\r\n                headers,\r\n                invocationId,\r\n                target: properties[3] as string,\r\n                type: MessageType.Invocation,\r\n            };\r\n        } else {\r\n            return {\r\n                arguments: properties[4],\r\n                headers,\r\n                target: properties[3],\r\n                type: MessageType.Invocation,\r\n            };\r\n        }\r\n\r\n    }\r\n\r\n    private createStreamItemMessage(headers: MessageHeaders, properties: any[]): StreamItemMessage {\r\n        // check minimum length to allow protocol to add items to the end of objects in future releases\r\n        if (properties.length < 4) {\r\n            throw new Error(\"Invalid payload for StreamItem message.\");\r\n        }\r\n\r\n        return {\r\n            headers,\r\n            invocationId: properties[2],\r\n            item: properties[3],\r\n            type: MessageType.StreamItem,\r\n        } as StreamItemMessage;\r\n    }\r\n\r\n    private createCompletionMessage(headers: MessageHeaders, properties: any[]): CompletionMessage {\r\n        // check minimum length to allow protocol to add items to the end of objects in future releases\r\n        if (properties.length < 4) {\r\n            throw new Error(\"Invalid payload for Completion message.\");\r\n        }\r\n\r\n        const errorResult = 1;\r\n        const voidResult = 2;\r\n        const nonVoidResult = 3;\r\n\r\n        const resultKind = properties[3];\r\n\r\n        if (resultKind !== voidResult && properties.length < 5) {\r\n            throw new Error(\"Invalid payload for Completion message.\");\r\n        }\r\n\r\n        const completionMessage = {\r\n            error: null as string,\r\n            headers,\r\n            invocationId: properties[2],\r\n            result: null as any,\r\n            type: MessageType.Completion,\r\n        };\r\n\r\n        switch (resultKind) {\r\n            case errorResult:\r\n                completionMessage.error = properties[4];\r\n                break;\r\n            case nonVoidResult:\r\n                completionMessage.result = properties[4];\r\n                break;\r\n        }\r\n\r\n        return completionMessage as CompletionMessage;\r\n    }\r\n\r\n    public writeMessage(message: HubMessage): ArrayBuffer {\r\n        switch (message.type) {\r\n            case MessageType.Invocation:\r\n                return this.writeInvocation(message as InvocationMessage);\r\n            case MessageType.StreamInvocation:\r\n                return this.writeStreamInvocation(message as StreamInvocationMessage);\r\n            case MessageType.StreamItem:\r\n            case MessageType.Completion:\r\n                throw new Error(`Writing messages of type '${message.type}' is not supported.`);\r\n            default:\r\n                throw new Error(\"Invalid message type.\");\r\n        }\r\n    }\r\n\r\n    private writeInvocation(invocationMessage: InvocationMessage): ArrayBuffer {\r\n        const msgpack = msgpack5();\r\n        const payload = msgpack.encode([MessageType.Invocation, invocationMessage.headers || {}, invocationMessage.invocationId || null,\r\n        invocationMessage.target, invocationMessage.arguments]);\r\n\r\n        return BinaryMessageFormat.write(payload.slice());\r\n    }\r\n\r\n    private writeStreamInvocation(streamInvocationMessage: StreamInvocationMessage): ArrayBuffer {\r\n        const msgpack = msgpack5();\r\n        const payload = msgpack.encode([MessageType.StreamInvocation, streamInvocationMessage.headers || {}, streamInvocationMessage.invocationId,\r\n        streamInvocationMessage.target, streamInvocationMessage.arguments]);\r\n\r\n        return BinaryMessageFormat.write(payload.slice());\r\n    }\r\n\r\n    private readHeaders(properties: any): MessageHeaders {\r\n        const headers: MessageHeaders = properties[1] as MessageHeaders;\r\n        if (typeof headers !== \"object\") {\r\n            throw new Error(\"Invalid headers.\");\r\n        }\r\n        return headers;\r\n    }\r\n}\r\n"]}